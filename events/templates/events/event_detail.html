{% extends "base.html" %}

{% block title %}{{ event.title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card">
      <div class="card-body">

        {% if event.status == "cancelled" %}
        <div class="alert alert-danger mb-3">This event has been cancelled.</div>
        {% endif %}

        <h2 class="card-title">{{ event.title }}</h2>

        <dl class="row mt-4">
          <dt class="col-sm-3">Date & Time</dt>
          <dd class="col-sm-9">{{ event.date_time|date:"N j, Y g:i A" }}</dd>

          <dt class="col-sm-3">Location</dt>
          <dd class="col-sm-9">{{ event.location }}</dd>

          <dt class="col-sm-3">Category</dt>
          <dd class="col-sm-9">{{ event.category.name }}</dd>

          <dt class="col-sm-3">Price</dt>
          <dd class="col-sm-9">
            {% if event.price == 0 %}Free{% else %}${{ event.price }}{% endif %}
          </dd>

          <dt class="col-sm-3">Hosted by</dt>
          <dd class="col-sm-9">{{ event.creator.username }}</dd>
        </dl>

        <h5 class="mt-4">Description</h5>
        <p>{{ event.description|linebreaks }}</p>

        <!-- RSVP Section -->
        <hr>
        <div class="d-flex align-items-center gap-3 mb-3">
          <h5 class="mb-0">Attendees ({{ attendee_count }})</h5>

          {% if request.user.is_authenticated and not is_creator and event.status != "cancelled" %}
            {% if has_rsvped %}
            <form method="post" action="{% url 'events:event_rsvp_cancel' event.pk %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-secondary btn-sm">Cancel RSVP</button>
            </form>
            {% else %}
            <form method="post" action="{% url 'events:event_rsvp' event.pk %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-success btn-sm">RSVP</button>
            </form>
            {% endif %}
          {% endif %}

          {% if has_rsvped %}
          <span class="badge bg-success">You're attending</span>
          {% endif %}
        </div>

        {% if attendee_list %}
        <ul class="list-group mb-3">
          {% for rsvp in attendee_list %}
          <li class="list-group-item">{{ rsvp.user.username }} — {{ rsvp.created_at|date:"N j, Y" }}</li>
          {% endfor %}
        </ul>
        {% endif %}

        {% if is_creator %}
        <hr>
        {% if is_creator %}
        <hr>
        <div class="d-flex gap-2">
          <a href="{% url 'events:event_edit' event.pk %}" class="btn btn-outline-primary">Edit Event</a>
          {% if event.status != "cancelled" %}
          <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelModal">
            Cancel Event
          </button>
          {% else %}
          <button class="btn btn-outline-danger" disabled>Event Cancelled</button>
          {% endif %}
        </div>

        <!-- Cancel Confirmation Modal -->
        {% if event.status != "cancelled" %}
        <div class="modal fade" id="cancelModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Cancel Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to cancel <strong>{{ event.title }}</strong>? This action cannot be undone.
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Event</button>
                <form method="post" action="{% url 'events:event_cancel' event.pk %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger">Yes, Cancel Event</button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        {% endif %}
        {% endif %}

        <a href="{% url 'events:event_list' %}" class="btn btn-link mt-3">← Back to Events</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}